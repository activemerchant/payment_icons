name: CI

on:
  pull_request:
    branches:
      - '**'
  push:
    branches:
      - master

jobs:
  build:
    name: Ruby ${{ matrix.version }} ${{ matrix.gemfile }}
    runs-on: ubuntu-latest
    env:
      BUNDLE_GEMFILE: ${{ matrix.gemfile }}
    strategy:
      matrix:
        version:
          - 3.3
          - 3.4
        gemfile:
          - gemfiles/rails-7-2.gemfile
          - gemfiles/rails-latest-release.gemfile
          - gemfiles/rails-edge.gemfile
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Need full history for git diff

      - name: Set up Ruby ${{ matrix.version }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.version }}
          bundler-cache: true
          rubygems: latest

      - name: Get changed SVG files (PR only)
        id: changed-files
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }}

          # Get all changed icons (new + modified)
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD \
            | grep 'app/assets/images/payment_icons/.*\.svg$' \
            | xargs -I {} basename {} .svg \
            | tr '\n' ',' \
            | sed 's/,$//' \
            || echo "")
          echo "icons=$CHANGED" >> $GITHUB_OUTPUT

          # Get only NEW icons (added files only)
          NEW=$(git diff --name-status origin/${{ github.base_ref }}...HEAD \
            | grep '^A.*app/assets/images/payment_icons/.*\.svg$' \
            | awk '{print $2}' \
            | xargs -I {} basename {} .svg \
            | tr '\n' ',' \
            | sed 's/,$//' \
            || echo "")
          echo "new_icons=$NEW" >> $GITHUB_OUTPUT

          if [ -n "$CHANGED" ]; then
            echo "âœ“ Changed SVG icons detected: $CHANGED"
          else
            echo "âœ“ No SVG icons changed in this PR"
          fi

          if [ -n "$NEW" ]; then
            echo "âœ“ New SVG icons detected: $NEW"
          fi

      - name: Test
        id: test
        continue-on-error: true
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ] && [ -n "${{ steps.changed-files.outputs.icons }}" ]; then
            echo "Running tests with selective enforcement for changed icons: ${{ steps.changed-files.outputs.icons }}"
            if [ -n "${{ steps.changed-files.outputs.new_icons }}" ]; then
              echo "Running strict name validation for new icons: ${{ steps.changed-files.outputs.new_icons }}"
              CHANGED_ICONS="${{ steps.changed-files.outputs.icons }}" NEW_ICONS="${{ steps.changed-files.outputs.new_icons }}" bundle exec rake test 2>&1 | tee test_output.log
            else
              CHANGED_ICONS="${{ steps.changed-files.outputs.icons }}" bundle exec rake test 2>&1 | tee test_output.log
            fi
          else
            echo "Running tests without selective enforcement"
            bundle exec rake test 2>&1 | tee test_output.log
          fi

      - name: Generate PR Comment
        if: failure() && github.event_name == 'pull_request' && steps.changed-files.outputs.icons != ''
        id: generate-comment
        run: |
          cat > pr_comment.md << 'EOF'
          ## ðŸ” Icon Validation Report

          Hi @${{ github.event.pull_request.user.login }}! ðŸ‘‹

          The automated tests found issues with your icon changes. Please review and fix before merging.

          EOF

          # Extract issues for each changed icon
          IFS=',' read -ra ICONS <<< "${{ steps.changed-files.outputs.icons }}"
          for icon in "${ICONS[@]}"; do
            # Get all failures and warnings for this icon
            ISSUES=$(grep -E "(Failure:.*'${icon}'|WARNING: '${icon}')" test_output.log || true)

            if [ -n "$ISSUES" ]; then
              # Check if it's a new icon
              if echo "${{ steps.changed-files.outputs.new_icons }}" | grep -q "$icon"; then
                echo "### ðŸ†• \`${icon}.svg\` (New Icon)" >> pr_comment.md
              else
                echo "### âœï¸ \`${icon}.svg\` (Modified Icon)" >> pr_comment.md
              fi
              echo "" >> pr_comment.md
              echo '```' >> pr_comment.md
              echo "$ISSUES" >> pr_comment.md
              echo '```' >> pr_comment.md
              echo "" >> pr_comment.md
            fi
          done

          # Add footer
          cat >> pr_comment.md << 'EOF'
          ---

          ### ðŸ“š Resources

          - [Contributing Guide](../blob/master/CONTRIBUTING.md) - How to create compliant icons
          - [Selective Enforcement Policy](../blob/master/SELECTIVE_ENFORCEMENT_POLICY.md) - Understanding test requirements

          ### ðŸ§ª Test Locally

          ```bash
          EOF

          if [ -n "${{ steps.changed-files.outputs.new_icons }}" ]; then
            echo "CHANGED_ICONS=\"${{ steps.changed-files.outputs.icons }}\" NEW_ICONS=\"${{ steps.changed-files.outputs.new_icons }}\" bundle exec rails test" >> pr_comment.md
          else
            echo "CHANGED_ICONS=\"${{ steps.changed-files.outputs.icons }}\" bundle exec rails test" >> pr_comment.md
          fi

          cat >> pr_comment.md << 'EOF'
          ```

          ---

          *ðŸ¤– Automated feedback from CI*
          EOF

      - name: Post PR Comment
        if: failure() && github.event_name == 'pull_request' && steps.generate-comment.outcome == 'success'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body-file pr_comment.md

      - name: Fail if tests failed
        if: steps.test.outcome == 'failure'
        run: |
          echo "Tests failed. Please review the PR comment for details."
          exit 1

